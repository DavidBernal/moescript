<!DOCTYPE HTML><html ><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><head ><title >moescript</title><style >@import url(rc/style.css);</style></head><body ><div id="contents"><div id="headarea"><h1>moescript</h1>
<div class="pageinfo"> Last update: 2012-03-31</div></div><p><strong>Moe is a new, not-very-little Javascript-targeted language written in JavaScript.</strong> Its features are inspired by Python, Haskell and Coffee. It is aimed to deal with common troubles in JavaScript development. Moe has neatly crafted grammar so that most JavaScript development will be simplified.</p>
<p>This document is an introduction of Moescript in examples. You can try Moescript online <a href="webtest/index.html">Here</a>.</p>
<p>You can get it from <a href="http://github.com/be5invis/moescript">http://github.com/be5invis/moescript</a>.</p>
<h2>Usage</h2>

<div class="show"><pre >&gt; moec &lt;options&gt; input.moe
</pre></div><div class="comm"><p>This is the Moescript compiler <code>moec</code>.</p>
<p>Options:</p>
<ul><li><code>-o &lt;value&gt;</code>, <code>--output &lt;value&gt;</code>: Specify the path of output file. If it is not specified, <code>moec</code> will print generated code into STDOUT.
</li>
<li><code>-t &lt;value&gt;</code>, <code>--target &lt;value&gt;</code>: Specify the compilation target which affects global variable list. <code>-t least</code> will provide <code>require</code>,<code>module</code> and <code>exports</code> only for globals. <code>-t node</code> will provide all Node global variables.
</li>
<li><code>-g &lt;value&gt;</code>, <code>--global &lt;value&gt;</code>: Specify a global variable, e.g. <code>-g document</code>.
</li>
<li><code>-m &lt;name&gt;=&lt;path&gt;</code>, <code>--module &lt;name&gt;=&lt;path&gt;</code>: Map a module into a global variable, for exmaple, <code>-m exp=express</code> will map <code>require('express')</code> into the global variablr <code>exp</code> inside Moe source.
</li>
</ul></div><div class="show"><pre class="mghl source javascript"><span class="identifier id">require</span><span class="punctor open">(</span><span class="string quote">'moe/dummy'</span><span class="punctor close">)</span></pre></div><div class="comm">The <code>moeDummy</code> module makes Node possible to load <code>.moe</code> files as well as <code>.js</code>. Everything required is a <code>require</code>.</div>
<h2>Overview</h2>

<div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">max</span><span class="punctor">(</span><span class="identifier">list</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">var</span> <span class="identifier">m</span> <span class="operator">=</span> <span class="identifier">list</span><span class="punctor">[</span><span class="number literal">0</span><span class="punctor">]</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">i</span> <span class="operator">in</span> <span class="number literal">0</span><span class="operator">..</span><span class="identifier">list</span><span class="punctor">.</span><span class="identifier">length</span><span class="punctor">)</span>
        <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">list</span><span class="punctor">[</span><span class="identifier">i</span><span class="punctor">]</span> <span class="operator">></span> <span class="identifier">m</span><span class="punctor">)</span> <span class="identifier">m</span> <span class="operator">=</span> <span class="identifier">list</span><span class="punctor">[</span><span class="identifier">i</span><span class="punctor">]</span>
    <span class="keyword flowctrl">return</span> <span class="identifier">m</span>
<span class="identifier">trace</span> <span class="identifier">max</span> <span class="punctor">[</span><span class="number literal">5</span><span class="punctor">,</span> <span class="number literal">4</span><span class="punctor">,</span> <span class="number literal">3</span><span class="punctor">,</span> <span class="number literal">2</span><span class="punctor">,</span> <span class="number literal">1</span><span class="punctor">]</span></pre></div><div class="comm">First, whitespaces plays important rule in Moe, indents means structure for example. There is nothing works like <code>end</code> or <code>{}</code> in other languages. It is not required to use <code>;</code> to terminate statements (though semiclolns still works as well), and use indentation instead of surrounding statements with <code>{}</code>.</div><div class="show"><pre class="mghl source moe"><span class="identifier">trace</span> <span class="punctor">\</span>        <span class="comment">// backslash-newline means nothing</span>
    <span class="number literal">1</span><span class="punctor">,</span> <span class="number literal">2</span><span class="punctor">,</span>
    <span class="punctor">(</span><span class="number literal">3</span> <span class="operator">+</span>
     <span class="number literal">4</span>
     <span class="operator">+</span> <span class="number literal">5</span><span class="punctor">)</span>
<span class="keyword">var</span> <span class="identifier">list</span> <span class="operator">=</span> <span class="punctor">[</span>   <span class="comment">// open brackets annihilates coming newlines.</span>
    <span class="number literal">1</span><span class="punctor">,</span>
    <span class="number literal">2</span><span class="punctor">,</span>
    <span class="number literal">3</span>
<span class="punctor">]</span></pre></div><div class="comm">Newlines are <strong>always</strong> "semicolons", expect appearances <strong>around</strong> some symbols will be ignored so that you could write long expressions or complex literals.</div><div class="show"><pre class="mghl source moe"><span class="comment">// Wrong example: newline inside parentheses</span>
<span class="comment">--	(trace  -- here</span>
<span class="comment">--		x,</span>
<span class="comment">--		y,</span>
<span class="comment">--		z)</span></pre></div><div class="comm"><p>Unlike python, line breaks <strong>inside</strong> parentheses, which often causes syntax errors, will not be ignored.</p>
<p>As what you seen, <code>//</code> and <code>--</code> leads comments.</p>
</div><div class="show"><pre class="mghl source moe"><span class="comment">// Strings here</span>
<span class="string literal">"This is a string. [\n] &lt;- Newline here. \u4e00"</span>
<span class="string literal">'This is a single quoted string. \no backslashes. '' &lt;- single quote here.'</span>
<span class="string literal">'''
    Multiple
    Line
    Strings.'''</span></pre></div><div class="comm"><p>Single quoted string have changed into a much simpler form. Backslashes in single-quoteds is not an escape character now. Double the quote sign to express the quote sumbol (<code>'</code>) itself.</p>
<p>You can also use Python-style multiple-line strings. Also, no escapes.</p>
</div><div class="show"><pre class="mghl source moe"><span class="number literal">0xCAFE9527</span>
<span class="number literal">1</span>
<span class="number literal">1.5</span>
<span class="number literal">1.5e5</span>
<span class="number literal">1.5e-5</span></pre></div><div class="comm">Parts of numbers in Moe cannot be omitted, so that <code>.5</code> is not a valid number.</div>
<h2>Variables (and immutable ones)</h2>

<div class="show"><pre class="mghl source moe"><span class="keyword">var</span> <span class="identifier">outer</span> <span class="operator">=</span> <span class="number literal">1</span>
<span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">=</span> <span class="number literal">2</span>
<span class="keyword">def</span> <span class="identifier">f</span> <span class="operator">=</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">var</span> <span class="identifier">inner</span> <span class="operator">=</span> <span class="number literal">3</span>
    <span class="identifier">outer</span> <span class="operator">=</span> <span class="number literal">4</span>
    <span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">=</span> <span class="number literal">5</span>
    <span class="identifier">trace</span> <span class="identifier">inner</span>  <span class="comment">-- 3</span>
    <span class="identifier">trace</span> <span class="identifier">outer</span>  <span class="comment">-- 4</span>
    <span class="identifier">trace</span> <span class="identifier">x</span>      <span class="comment">-- 5</span>
<span class="identifier">f</span><span class="punctor">(</span><span class="punctor">)</span>
<span class="identifier">trace</span> <span class="identifier">outer</span>      <span class="comment">-- 4</span>
<span class="identifier">trace</span> <span class="identifier">x</span>          <span class="comment">-- 2</span></pre></div><div class="comm"><p>Variables in Moe is defined by <code>var</code> or <code>def</code>. "Variables" defined by <code>def</code> is actually a constant, which means it is impossible make any assignment to it. Scopes rule is exactly same as JavaScript, <code>var</code> and <code>def</code> <strong>shadows</strong> external variables.</p>
<p><code>def</code> can only define one thing once, with <code>var</code> can declares multiple variables without initialization. However, you are able to use <code>def</code> for defining properties, which is useful processing objects. In this situation, <code>def</code> is only a simple assignment.</p>
<pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">Number</span><span class="punctor">.</span><span class="identifier">prototype</span><span class="punctor">.</span><span class="identifier">times</span> <span class="operator">=</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">f</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">i</span> <span class="operator">in</span> <span class="number literal">0</span><span class="operator">..</span><span class="keyword">this</span><span class="punctor">)</span> <span class="identifier">f</span><span class="punctor">(</span><span class="identifier">i</span><span class="punctor">)</span></pre></div>
<h2>Operators</h2>

<p>Operators in Moescript are <strong>all</strong> binary, with the priority listed below:</p>
<pre >(omissioned calls)
*   /   %
+   -
&lt;   &gt;   &lt;=  &gt;=
is
==  !=  =~  !~  === !==
and &amp;&amp;
or  ||
..  ...
as
(pipe calls)
(when clauses)
(where clause)
(assignments)

</pre><p>Most opeators are left-associative, except assignments are right-associative and boolean operators are non-associative. There are <strong>no</strong> unary opeators. Use <code>not</code> and <code>negate</code> functions.</p>
<p><code>==</code> and <code>===</code> has the same meaning in Moe, which is strict equality test. The mignt-be-harmful non-strict equal(<code>==</code>) in JavaScript is <code>=~</code> in Moe.</p>
<p>The behavior of <code>is</code> and <code>as</code> operator is customizable. <code>x is y</code> means <code>y.be x</code> while <code>x as y</code> means <code>y.convertFrom x</code>. As a syntax sugar, <code>x is in y</code>, or actually <code>x is in(y)</code>, means <code>y.contains(x)</code>.</p>
<p>Operators could be <strong>wrapped</strong> into functions directly using <code>(op)</code> or <code>(op right)</code>. So that <code>(+)</code> means <code>(x, y) =&gt; x + y</code> while <code>(+ 5)</code> means <code>(x) =&gt; x + 5</code>.</p>

<h2>Flow control</h2>

<div class="show"><pre class="mghl source moe"><span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="literal">true</span> <span class="operator">==</span> <span class="literal">true</span><span class="punctor">)</span>
    <span class="identifier">trace</span> <span class="string literal">"We are OK!"</span>
<span class="keyword flowctrl">else</span> <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="literal">true</span> <span class="operator">!=</span> <span class="literal">true</span><span class="punctor">)</span> <span class="identifier">trace</span> <span class="string literal">"Panic"</span>
<span class="keyword flowctrl">else</span>
    <span class="identifier">trace</span> <span class="string literal">"The world is crazy!"</span>
    <span class="identifier">trace</span> <span class="string literal">"Really crazy!"</span>

<span class="comment">// e1 when(cond), e2 means (cond ? e1 : e2)</span>
<span class="keyword">def</span> <span class="identifier">absolute</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> 
    <span class="identifier">negate</span> <span class="identifier">x</span> <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">x</span> <span class="operator">&lt;</span> <span class="number literal">0</span><span class="punctor">)</span><span class="punctor">,</span>
    <span class="identifier">x</span>

<span class="keyword">def</span> <span class="identifier">gpa</span><span class="punctor">(</span><span class="identifier">score</span><span class="punctor">)</span> <span class="operator">=</span> <span class="keyword flowctrl">piecewise</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">100</span><span class="punctor">)</span> <span class="number literal">5</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">90</span><span class="punctor">)</span>  <span class="number literal">4</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">85</span><span class="punctor">)</span>  <span class="number literal">3.5</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">80</span><span class="punctor">)</span>  <span class="number literal">3</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">70</span><span class="punctor">)</span>  <span class="number literal">2</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">score</span> <span class="operator">>=</span> <span class="number literal">60</span><span class="punctor">)</span>  <span class="number literal">1</span>
    <span class="keyword flowctrl">otherwise</span>          <span class="number literal">0</span>

<span class="keyword">def</span> <span class="identifier">grade</span><span class="punctor">(</span><span class="identifier">score</span><span class="punctor">)</span> <span class="operator">=</span> <span class="keyword flowctrl">case</span><span class="punctor">(</span><span class="identifier">gpa</span> <span class="identifier">score</span><span class="punctor">)</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">5</span><span class="punctor">)</span>            <span class="string literal">"Perfect!"</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">4</span><span class="punctor">)</span>            <span class="string literal">"Excillent!"</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">3.5</span><span class="punctor">)</span>          <span class="string literal">"Pretty good!"</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">3</span><span class="punctor">)</span>            <span class="string literal">"Good!"</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">2</span><span class="punctor">)</span>            <span class="string literal">"OK!"</span>
    <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">1</span><span class="punctor">)</span> <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="number literal">0</span><span class="punctor">)</span>    <span class="string literal">"Cheer up!"</span>
    <span class="keyword flowctrl">otherwise</span>          <span class="keyword flowctrl">throw</span> <span class="string literal">"Score Error!"</span></pre></div><div class="comm">Conditionals.</div><div class="show"><pre class="mghl source moe"><span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">x</span><span class="punctor">,</span> <span class="identifier">i</span> <span class="operator">in</span> <span class="identifier">enumerable</span><span class="punctor">)</span>
    <span class="identifier">action</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">,</span> <span class="identifier">i</span><span class="punctor">)</span>

<span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="operator">*</span><span class="identifier">terms</span> <span class="operator">in</span> <span class="identifier">enumerable</span><span class="punctor">)</span>
    <span class="identifier">action</span><span class="punctor">(</span><span class="identifier">terms</span><span class="punctor">)</span> 
    <span class="comment">-- terms is an array containing all items yield from enumerator</span></pre></div><div class="comm"><p>For statement. <code>for(x, i in range) body</code> means:</p>
<pre class="mghl source moe"><span class="keyword">var</span> <span class="identifier">enumerator</span> <span class="operator">=</span> <span class="identifier">range</span><span class="punctor">.</span><span class="identifier">getEnumerator</span><span class="punctor">(</span><span class="punctor">)</span>
<span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="identifier">terms</span> <span class="operator">=</span> <span class="identifier">range</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span>
    <span class="identifier">x</span> <span class="operator">=</span> <span class="identifier">terms</span><span class="punctor">[</span><span class="number literal">0</span><span class="punctor">]</span>
    <span class="identifier">i</span> <span class="operator">=</span> <span class="identifier">terms</span><span class="punctor">[</span><span class="number literal">1</span><span class="punctor">]</span>
    <span class="identifier">body</span></pre><p><code>for(*terms in range) body</code> means:</p>
<pre class="mghl source moe"><span class="keyword">var</span> <span class="identifier">enumerator</span> <span class="operator">=</span> <span class="identifier">range</span><span class="punctor">.</span><span class="identifier">getEnumerator</span><span class="punctor">(</span><span class="punctor">)</span>
<span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="identifier">terms</span> <span class="operator">=</span> <span class="identifier">range</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span>
    <span class="identifier">body</span></pre><p><code>for(var x in low..high)</code> means <code>for(var x = low; x &lt; high; x++)</code> in Javascript. <code>for(var x in low...high)</code> means <code>for(var x = low; x &lt;= high; x++)</code>.</p>
</div><div class="show"><pre class="mghl source moe"><span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="identifier">condition</span><span class="punctor">)</span>
    <span class="identifier">action</span>

<span class="keyword flowctrl">repeat</span>
    <span class="identifier">action</span>
<span class="keyword flowctrl">until</span><span class="punctor">(</span><span class="identifier">condition</span><span class="punctor">)</span></pre></div><div class="comm"><code>while</code> and <code>repeat-until</code>.</div><div class="show"><pre class="mghl source moe"><span class="keyword flowctrl">label</span> <span class="identifier">out</span><span class="punctor">:</span> <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">in</span> <span class="number literal">1</span><span class="operator">..</span><span class="number literal">55</span><span class="punctor">)</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">y</span> <span class="operator">in</span> <span class="identifier">x</span><span class="operator">..</span><span class="number literal">55</span><span class="punctor">)</span>
        <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">x</span> <span class="operator">+</span> <span class="identifier">y</span> <span class="operator">==</span> <span class="number literal">42</span><span class="punctor">)</span>
            <span class="keyword flowctrl">break</span> <span class="identifier">out</span></pre></div><div class="comm">Break and labels. You can <code>break</code> loops only while only loops could be labelled.</div>
<h2>Objects</h2>

<div class="show"><pre class="mghl source moe"><span class="comment">-- A game config</span>
<span class="keyword">def</span> <span class="identifier">gameConfig</span> <span class="operator">=</span> <span class="punctor">[</span>
    <span class="identifier">player</span><span class="punctor">:</span> <span class="punctor">[</span>
        <span class="identifier">name</span><span class="punctor">:</span> <span class="string literal">"tom"</span><span class="punctor">,</span>
        <span class="identifier">type</span><span class="punctor">:</span> <span class="identifier">Human</span><span class="punctor">,</span>
        <span class="identifier">level</span><span class="punctor">:</span> <span class="number literal">1</span><span class="punctor">,</span>
        <span class="identifier">weapon</span><span class="punctor">:</span> <span class="identifier">sword</span><span class="punctor">,</span>
        <span class="identifier">inventory</span><span class="punctor">:</span> <span class="punctor">[</span><span class="identifier">food</span><span class="punctor">,</span> <span class="identifier">food</span><span class="punctor">,</span> <span class="identifier">potion</span><span class="punctor">,</span> <span class="identifier">bomb</span><span class="punctor">]</span>
    <span class="punctor">]</span><span class="punctor">,</span>
    <span class="identifier">enemy</span><span class="punctor">:</span> <span class="punctor">[</span>
        <span class="identifier">name</span><span class="punctor">:</span> <span class="string literal">"Dragon"</span><span class="punctor">,</span>
        <span class="identifier">type</span><span class="punctor">:</span> <span class="identifier">Dragon</span><span class="punctor">,</span>
        <span class="identifier">level</span><span class="punctor">:</span> <span class="number literal">9</span>
    <span class="punctor">]</span>
<span class="punctor">]</span>

<span class="comment">// some lisp code</span>
<span class="keyword">def</span> <span class="identifier">code</span> <span class="operator">=</span> <span class="punctor">[</span><span class="string literal">'define'</span><span class="punctor">,</span> <span class="punctor">[</span><span class="string literal">'fib'</span><span class="punctor">,</span> <span class="string literal">'n'</span><span class="punctor">]</span><span class="punctor">,</span>
    <span class="punctor">[</span><span class="string literal">'cond'</span><span class="punctor">,</span>
      <span class="punctor">[</span> <span class="punctor">[</span><span class="punctor">[</span><span class="string literal">'='</span><span class="punctor">,</span> <span class="string literal">'n'</span><span class="punctor">,</span> <span class="string literal">'1'</span><span class="punctor">]</span><span class="punctor">,</span> <span class="string literal">'1'</span><span class="punctor">]</span><span class="punctor">,</span>
        <span class="punctor">[</span><span class="punctor">[</span><span class="string literal">'='</span><span class="punctor">,</span> <span class="string literal">'n'</span><span class="punctor">,</span> <span class="string literal">'2'</span><span class="punctor">]</span><span class="punctor">,</span> <span class="string literal">'1'</span><span class="punctor">]</span><span class="punctor">,</span>
        <span class="punctor">[</span><span class="string literal">'()'</span><span class="punctor">,</span> 
            <span class="punctor">[</span><span class="string literal">'+'</span><span class="punctor">,</span> <span class="punctor">[</span><span class="string literal">'fib'</span><span class="punctor">,</span> <span class="punctor">[</span><span class="string literal">'-'</span><span class="punctor">,</span> <span class="string literal">'n'</span><span class="punctor">,</span> <span class="string literal">'1'</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">,</span>
                <span class="punctor">[</span><span class="string literal">'fib'</span><span class="punctor">,</span> <span class="punctor">[</span><span class="string literal">'-'</span><span class="punctor">,</span> <span class="string literal">'n'</span><span class="punctor">,</span> <span class="string literal">'2'</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">]</span><span class="punctor">]</span></pre></div><div class="comm">Both object literals and array literals uses <code>[]</code>. Therefore, expressing empty objects should use <code>[:]</code> while <code>[]</code> means empty array.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">actions</span> <span class="operator">=</span> <span class="punctor">[</span>
    <span class="keyword flowctrl">if</span><span class="punctor">:</span> <span class="punctor">(</span><span class="punctor">(</span><span class="identifier">cond</span><span class="punctor">,</span> <span class="identifier">fThen</span><span class="punctor">,</span> <span class="identifier">fElse</span><span class="punctor">)</span> <span class="operator">=></span> <span class="identifier">fThen</span><span class="punctor">(</span><span class="punctor">)</span> <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">cond</span><span class="punctor">)</span><span class="punctor">,</span> <span class="identifier">fElse</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span><span class="punctor">,</span>
    <span class="string literal">"while"</span><span class="punctor">:</span> <span class="punctor">(</span><span class="punctor">(</span><span class="identifier">fCond</span><span class="punctor">,</span> <span class="identifier">fBody</span><span class="punctor">)</span> <span class="operator">=></span> <span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="identifier">fCond</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span> <span class="identifier">fBody</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span>
<span class="punctor">]</span></pre></div><div class="comm">Keywords can appear inside object literals without quoting.</div><div class="show"><pre class="mghl source moe"><span class="comment">-- function object: creates object using a constructor with an optional prototype.</span>
<span class="comment">-- object(oPrototype, fConstruct) &lt;- Derives(oPrototype)</span>
<span class="comment">-- object(fConstruct) &lt;- Object</span>

<span class="keyword">def</span> <span class="identifier">gameConfig</span> <span class="operator">=</span> <span class="identifier">object</span> <span class="operator">=></span>
    <span class="operator">@</span><span class="identifier">player</span> <span class="operator">=</span> <span class="identifier">object</span> <span class="operator">=></span>
        <span class="operator">@</span><span class="identifier">name</span> <span class="operator">=</span> <span class="string literal">"tom"</span>
        <span class="operator">@</span><span class="identifier">type</span> <span class="operator">=</span> <span class="identifier">Human</span>
        <span class="operator">@</span><span class="identifier">level</span> <span class="operator">=</span> <span class="number literal">1</span>
        <span class="operator">@</span><span class="identifier">weapon</span> <span class="operator">=</span> <span class="identifier">sword</span>
        <span class="operator">@</span><span class="identifier">inventory</span> <span class="operator">=</span> <span class="punctor">[</span><span class="identifier">food</span><span class="punctor">,</span> <span class="identifier">food</span><span class="punctor">,</span> <span class="identifier">potion</span><span class="punctor">,</span> <span class="identifier">bomb</span><span class="punctor">]</span>
    <span class="operator">@</span><span class="identifier">enemy</span> <span class="operator">=</span> <span class="identifier">object</span> <span class="operator">=></span>
        <span class="operator">@</span><span class="identifier">name</span> <span class="operator">=</span> <span class="string literal">"Dragon"</span>
        <span class="operator">@</span><span class="identifier">type</span> <span class="operator">=</span> <span class="identifier">Dragon</span>
        <span class="operator">@</span><span class="identifier">level</span> <span class="operator">=</span> <span class="number literal">9</span></pre></div><div class="comm">You can also use <code>object</code> function provided in standard libary for large objects, especially configs.</div>
<h2>Functions</h2>

<div class="show"><pre class="mghl source moe"><span class="comment">// Define a simple function</span>
<span class="comment">-- function square: calculate square of a number</span>
<span class="comment">-- square(x &lt;- Number) &lt;- Number</span>
<span class="keyword">def</span> <span class="identifier">square</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span></pre></div><div class="comm">To define a simple function, you can write <code>def functionName(argList) = result</code> simply.</div><div class="show"><pre class="mghl source moe"><span class="comment">// A procedure.</span>
<span class="comment">-- function printPrimes: print all prime numbers </span>
<span class="comment">--  not greater than an uplimit specified</span>
<span class="comment">-- printPrimes(uplimit &lt;- Number)</span>
<span class="keyword">def</span> <span class="identifier">printPrimes</span><span class="punctor">(</span><span class="identifier">uplimit</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">def</span> <span class="identifier">primes</span> <span class="operator">=</span> <span class="punctor">[</span><span class="number literal">2</span><span class="punctor">,</span> <span class="number literal">3</span><span class="punctor">,</span> <span class="number literal">5</span><span class="punctor">,</span> <span class="number literal">7</span><span class="punctor">]</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">n</span> <span class="operator">in</span> <span class="number literal">2</span> <span class="operator">...</span> <span class="identifier">uplimit</span><span class="punctor">)</span>
        <span class="keyword">var</span> <span class="identifier">composite</span> <span class="operator">=</span> <span class="literal">false</span>
        <span class="keyword">var</span> <span class="identifier">t</span> <span class="operator">=</span> <span class="number literal">0</span>
        <span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="identifier">square</span> <span class="identifier">primes</span><span class="punctor">[</span><span class="identifier">t</span><span class="punctor">]</span> <span class="operator">&lt;=</span> <span class="identifier">n</span><span class="punctor">)</span>
            <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">%</span> <span class="identifier">primes</span><span class="punctor">[</span><span class="identifier">t</span><span class="punctor">]</span> <span class="operator">==</span> <span class="number literal">0</span><span class="punctor">)</span>
                <span class="identifier">composite</span> <span class="operator">=</span> <span class="literal">true</span>
                <span class="keyword flowctrl">break</span>
            <span class="identifier">t</span> <span class="operator">+=</span> <span class="number literal">1</span>
        <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="operator">not</span> <span class="identifier">composite</span><span class="punctor">)</span>
            <span class="identifier">primes</span><span class="punctor">.</span><span class="identifier">push</span> <span class="identifier">n</span>
            <span class="identifier">trace</span> <span class="identifier">n</span>

<span class="keyword">def</span> <span class="identifier">outNum</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">:</span> <span class="identifier">trace</span> <span class="punctor">(</span><span class="identifier">x</span> <span class="operator">-</span> <span class="number literal">0</span><span class="punctor">)</span></pre></div><div class="comm">To define a more complicated function, use colon and indents.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">Y</span><span class="punctor">(</span><span class="identifier">g</span><span class="punctor">)</span> <span class="operator">=</span>
    <span class="keyword">def</span> <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">(</span><span class="identifier">y</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">g</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">)</span> <span class="identifier">y</span>
    <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">rec</span><span class="punctor">)</span>
<span class="keyword">def</span> <span class="identifier">Y1</span><span class="punctor">(</span><span class="identifier">g</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">def</span> <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">(</span><span class="identifier">y</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">g</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">)</span> <span class="identifier">y</span>
    <span class="keyword flowctrl">return</span> <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">rec</span><span class="punctor">)</span></pre></div><div class="comm">In Moe, colon-forms requires to write <code>return</code> statement explicitly, while functions using equal sign (<code>=</code>) does not. Functions indicated by equals will contain automatically generated <code>return</code>'s.</div><div class="show"><pre class="mghl source moe"><span class="comment">// Parameters with default value</span>
<span class="keyword">def</span> <span class="identifier">fill</span><span class="punctor">(</span><span class="identifier">container</span><span class="punctor">,</span> <span class="identifier">liquid</span> <span class="operator">=</span> <span class="string literal">"water"</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="identifier">trace</span> <span class="punctor">(</span><span class="string literal">"Fill "</span> <span class="operator">+</span> <span class="identifier">container</span> <span class="operator">+</span> <span class="string literal">" with "</span> <span class="operator">+</span> <span class="identifier">liquid</span><span class="punctor">)</span></pre></div><div class="comm">Parameters can have default values. Specify it by using <code>=</code>.</div><div class="show"><pre class="mghl source moe"><span class="comment">-- function Y: Fixed point combinator</span>
<span class="comment">-- Y(g &lt;- Function) &lt;- Function</span>
<span class="comment">--     which Y(g)(x) = g(Y(g))(x)</span>
<span class="keyword">def</span> <span class="identifier">Y</span><span class="punctor">(</span><span class="identifier">g</span><span class="punctor">)</span> <span class="operator">=</span>
    <span class="keyword">def</span> <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">(</span><span class="identifier">y</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">g</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">)</span> <span class="identifier">y</span>
    <span class="identifier">rec</span><span class="punctor">(</span><span class="identifier">rec</span><span class="punctor">)</span>

<span class="comment">// Define recursive function using Y</span>
<span class="keyword">def</span> <span class="identifier">Y</span> <span class="identifier">fibonacci</span><span class="punctor">(</span><span class="identifier">recurse</span><span class="punctor">)</span><span class="punctor">(</span><span class="identifier">n</span><span class="punctor">)</span> <span class="operator">=</span>
    <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">&lt;=</span> <span class="number literal">2</span><span class="punctor">)</span> <span class="number literal">1</span>
    <span class="keyword flowctrl">else</span> <span class="identifier">recurse</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">2</span><span class="punctor">)</span> <span class="operator">+</span> <span class="identifier">recurse</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">1</span><span class="punctor">)</span>

<span class="identifier">fibonacci</span><span class="punctor">(</span><span class="number literal">5</span><span class="punctor">)</span> <span class="comment">// 5</span></pre></div><div class="comm"><p>A slightly complicated example. <code>Y</code> is the fixed point combinator, and <code>def Y f(args)...</code> means <code>def f = Y function(args)...</code>. In this example, <code>fibonacci</code> is actually:</p>
<pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">fibonacci_1</span> <span class="operator">=</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">recurse</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword flowctrl">return</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">n</span><span class="punctor">)</span><span class="punctor">:</span>
        <span class="keyword flowctrl">return</span> <span class="number literal">1</span> <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">&lt;=</span> <span class="number literal">2</span><span class="punctor">)</span><span class="punctor">,</span>
        <span class="identifier">recurse</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">2</span><span class="punctor">)</span> <span class="operator">+</span> <span class="identifier">recurse</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">1</span><span class="punctor">)</span>
<span class="keyword">def</span> <span class="identifier">fibonacci</span> <span class="operator">=</span> <span class="identifier">Y</span><span class="punctor">(</span><span class="identifier">fibonacci_1</span><span class="punctor">)</span></pre></div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">fibonacci</span> <span class="operator">=</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">n</span><span class="punctor">)</span><span class="operator">=</span>
    <span class="number literal">1</span> <span class="keyword flowctrl">when</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">&lt;=</span> <span class="number literal">2</span><span class="punctor">)</span><span class="punctor">,</span>
    <span class="identifier">fibonacci</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">2</span><span class="punctor">)</span> <span class="operator">+</span> <span class="identifier">fibonacci</span><span class="punctor">(</span><span class="identifier">n</span> <span class="operator">-</span> <span class="number literal">1</span><span class="punctor">)</span></pre></div><div class="comm">No-name functions can be defined using <code>function</code> keyword, followed by argument lists, a colon or an equal sign, then the function body. Like functions in <code>def</code>, <code>=</code> for automatic generated <code>return</code>s, <code>:</code> for manual.</div><div class="show"><pre class="mghl source moe"><span class="identifier">list</span><span class="punctor">.</span><span class="identifier">map</span> <span class="punctor">(</span><span class="identifier">term</span><span class="punctor">,</span> <span class="identifier">index</span><span class="punctor">)</span> <span class="operator">=></span> <span class="identifier">term</span> <span class="operator">*</span> <span class="identifier">index</span>
<span class="identifier">$</span><span class="punctor">(</span><span class="identifier">element</span><span class="punctor">)</span><span class="punctor">.</span><span class="identifier">bind</span> <span class="string literal">"click"</span><span class="punctor">,</span> <span class="punctor">(</span><span class="identifier">event</span><span class="punctor">)</span> <span class="operator">:></span>
    <span class="identifier">trace</span> <span class="identifier">event</span>

<span class="keyword">def</span> <span class="identifier">sleep</span><span class="punctor">(</span><span class="identifier">dt</span><span class="punctor">,</span> <span class="identifier">f</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">setTimeout</span><span class="punctor">(</span><span class="identifier">f</span><span class="punctor">,</span> <span class="identifier">dt</span><span class="punctor">)</span>
<span class="identifier">sleep</span> <span class="number literal">1000</span><span class="punctor">,</span> <span class="operator">:></span>
    <span class="identifier">trace</span> <span class="string literal">'Blah!'</span>
<span class="comment">// Note: different from (act) :> something</span>
<span class="identifier">act</span> <span class="operator">:></span> <span class="identifier">something</span></pre></div><div class="comm">You can also define a function using <strong>lambda expressions</strong>, by using an optional list of parameters, an arrow(<code>:&gt;</code> or <code>=&gt;</code>), and the function body. Unindented Lambdas will extend all the way to the right as long aspossible. The colon-equal rule still rules here.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">repeatWhile</span><span class="punctor">(</span><span class="identifier">condition</span><span class="punctor">,</span> <span class="identifier">body</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">var</span> <span class="identifier">c</span>
    <span class="keyword flowctrl">while</span><span class="punctor">(</span><span class="punctor">(</span><span class="identifier">c</span> <span class="operator">=</span> <span class="identifier">condition</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span><span class="punctor">)</span>
        <span class="identifier">body</span><span class="punctor">(</span><span class="identifier">c</span><span class="punctor">)</span>

<span class="keyword">var</span> <span class="identifier">num</span> <span class="operator">=</span> <span class="number literal">10</span>
<span class="identifier">repeatWhile</span> <span class="punctor">{</span><span class="identifier">num</span> <span class="operator">-=</span> <span class="number literal">1</span><span class="punctor">}</span><span class="punctor">,</span> <span class="punctor">{</span><span class="operator">|</span><span class="identifier">j</span><span class="operator">|</span> <span class="identifier">trace</span> <span class="identifier">j</span><span class="punctor">}</span></pre></div><div class="comm">The last way is to use curly brackets (<code>{}</code>) enclose statements, separated by explicit semicolons, not line breaks. <code>return</code>'s will be automatically generated. Arguments are writtern inside the brackets, and wrapped by <code>|</code>'s, when necessary.</div>
<h2><code>where</code> clause</h2>

<div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">math</span> <span class="operator">=</span> <span class="punctor">[</span><span class="identifier">square</span><span class="punctor">:</span> <span class="identifier">square</span><span class="punctor">,</span> <span class="identifier">cube</span><span class="punctor">:</span> <span class="identifier">cube</span><span class="punctor">]</span>
<span class="keyword">where</span> <span class="identifier">square</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span>
      <span class="identifier">cube</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">square</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span></pre></div><div class="comm"><p>The <code>where</code> clause in Moescript provided a convient way to create "modules". The code above acts actually</p>
<pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">math</span> <span class="operator">=</span> <span class="keyword">do</span> <span class="operator">=></span>
    <span class="keyword">def</span> <span class="identifier">square</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span>
    <span class="keyword">def</span> <span class="identifier">cube</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">square</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span>
    <span class="punctor">[</span><span class="identifier">square</span><span class="punctor">:</span> <span class="identifier">square</span><span class="punctor">,</span> <span class="identifier">cube</span><span class="punctor">:</span> <span class="identifier">cube</span><span class="punctor">]</span></pre></div>
<h2>Calling functions</h2>

<div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">f</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">,</span> <span class="identifier">y</span><span class="punctor">,</span> <span class="identifier">z</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">y</span> <span class="operator">+</span> <span class="identifier">z</span>
<span class="identifier">f</span><span class="punctor">(</span><span class="number literal">1</span><span class="punctor">,</span> <span class="number literal">1</span><span class="punctor">,</span> <span class="number literal">1</span><span class="punctor">)</span> <span class="comment">// 2</span>

<span class="keyword">def</span> <span class="identifier">act</span><span class="punctor">(</span><span class="identifier">f</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">f</span><span class="punctor">(</span><span class="punctor">)</span>
<span class="identifier">act</span><span class="punctor">{</span><span class="identifier">trace</span> <span class="string literal">'blah!'</span><span class="punctor">}</span> <span class="comment">// short for act({trace 'blah!'})</span></pre></div><div class="comm"><p>Call function by <code>f(args)</code>. There <strong>should not be any space</strong> between the function and the bracket <code>(</code>.</p>
<p><code>f({func})</code> could be simplified into <code>f{func}</code>.</p>
</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">f</span><span class="punctor">(</span><span class="identifier">config</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">config</span><span class="punctor">.</span><span class="identifier">a</span> <span class="operator">+</span> <span class="identifier">config</span><span class="punctor">.</span><span class="identifier">b</span>
<span class="identifier">f</span><span class="punctor">(</span><span class="identifier">a</span><span class="punctor">:</span> <span class="number literal">1</span><span class="punctor">,</span> <span class="identifier">b</span><span class="punctor">:</span> <span class="number literal">2</span><span class="punctor">)</span> <span class="comment">// 3</span></pre></div><div class="comm">You can use named arguments. All named arguments will be accumulated into an object literal passed into the function as the last argument.</div><div class="show"><pre class="mghl source moe"><span class="identifier">f</span> <span class="identifier">g</span> <span class="identifier">h</span> <span class="identifier">a</span><span class="punctor">,</span> <span class="identifier">b</span><span class="punctor">,</span> <span class="identifier">c</span>   <span class="comment">// = f(g(h(a, b, v)))</span>
<span class="identifier">x</span> <span class="identifier">y</span> <span class="identifier">z</span> <span class="identifier">w</span>         <span class="comment">// = x(y(z(w)))</span>
<span class="identifier">f</span>               <span class="comment">// = f; No invocation.</span>
<span class="identifier">square</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">x</span>    <span class="comment">// = square(x) * x; Not square(x * x)</span></pre></div><div class="comm">Brackets can be omitted when it is not aminigous. Omissioned calls has a lower priority than calls using brackets, but higher than operators. Therefore, <code>square x * x</code> means <code>square(x) * x</code>.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">tap</span><span class="punctor">(</span><span class="identifier">value</span><span class="punctor">,</span> <span class="identifier">f</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">seq</span> <span class="identifier">f</span><span class="punctor">(</span><span class="identifier">value</span><span class="punctor">)</span><span class="punctor">,</span> <span class="identifier">value</span>
<span class="number literal">5</span> <span class="operator">|</span><span class="identifier">tap</span> <span class="punctor">{</span><span class="operator">|</span><span class="identifier">x</span><span class="operator">|</span> <span class="identifier">trace</span> <span class="identifier">x</span><span class="punctor">}</span>              <span class="comment">// 5</span>
  <span class="operator">|</span><span class="punctor">{</span><span class="operator">|</span><span class="identifier">x</span><span class="operator">|</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="number literal">3</span><span class="punctor">}</span>
  <span class="operator">|</span><span class="identifier">tap</span> <span class="punctor">{</span><span class="operator">|</span><span class="identifier">x</span><span class="operator">|</span> <span class="identifier">trace</span> <span class="identifier">x</span><span class="punctor">}</span>              <span class="comment">// 15</span></pre></div><div class="comm">Moe supports a special calling method, by using "Pipe sign" <code>|</code>, which has an extremely low priority. The calling form <code>a |f b, c, d</code> means <code>f(a, b, c, d)</code>, or more strictly, <code>seq T = a, f(T, b, c, d)</code> due to <code>a</code> will be evaluated <strong>before</strong> <code>f</code>. <code>a |f</code> means <code>f(a)</code>, with reversed evaluation order, <code>a</code> before <code>f</code>.</div><div class="show"><pre class="mghl source moe"><span class="identifier">$</span> <span class="string literal">"selector"</span>
  <span class="operator">|</span><span class="punctor">.</span><span class="identifier">addClass</span> <span class="string literal">"selected"</span>
  <span class="operator">|</span><span class="punctor">.</span><span class="identifier">css</span> <span class="identifier">background</span><span class="punctor">:</span> <span class="string literal">"red"</span></pre></div><div class="comm">Chain calls, usually used in JavaScript, is supported by a slightly modified pipe <code>|.</code>. Add the method name after the pipe-dot sign. Both pipe forms can be combined in any order.</div><h3>Call wrappers</h3>

<p>There are some special keywords, which can be "called" like normal function in Moe, called Call Wrappers, used to generate special codes, including object creation, prototype resending, or create "wait" calls used by asynchronous functions. All call wrappers are "called" in compile time, accepts only one argument, with some of them only accepts an invocation expression as its argument.</p>
<div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">Point</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">,</span> <span class="identifier">y</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">this</span><span class="punctor">.</span><span class="identifier">x</span> <span class="operator">=</span> <span class="identifier">x</span>
    <span class="keyword">this</span><span class="punctor">.</span><span class="identifier">y</span> <span class="operator">=</span> <span class="identifier">y</span>

<span class="keyword">def</span> <span class="identifier">origin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="identifier">Point</span> <span class="number literal">0</span><span class="punctor">,</span> <span class="number literal">0</span></pre></div><div class="comm">Creating objects using <code>new</code>.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">Man</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="comment">//...</span>
<span class="keyword">def</span> <span class="identifier">Man</span><span class="operator">::</span><span class="identifier">speak</span><span class="punctor">(</span><span class="identifier">something</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">trace</span> <span class="identifier">something</span>

<span class="keyword">def</span> <span class="identifier">outof</span><span class="punctor">(</span><span class="identifier">Man</span><span class="punctor">)</span> <span class="identifier">Child</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="comment">//...</span>
<span class="keyword">def</span> <span class="identifier">Child</span><span class="operator">::</span><span class="identifier">speak</span><span class="punctor">(</span><span class="identifier">something</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="identifier">trace</span> <span class="string literal">"Ah!"</span>
    <span class="identifier">trace</span> <span class="keyword">resend</span> <span class="identifier">Man</span><span class="operator">::</span><span class="identifier">speak</span><span class="punctor">(</span><span class="identifier">something</span><span class="punctor">)</span>
    <span class="comment">// is equalivent to trace Man.prototype.speak.call(this, something)</span></pre></div><div class="comm"><p><code>resend</code>, followed with a function call, is used to call methods with <code>this</code> bound to <code>this</code> of current scope. <code>resend method(args)</code> stands for <code>method.call(this, args)</code>.</p>
<p><code>do</code> acts like <code>resend</code>. The only difference between <code>do</code> and <code>resend</code> is that <code>do f</code> means <code>f.apply(this, arguments)</code>, while <code>resend f</code> throws a syntax error. <code>resend</code> accepts function calls only.</p>
</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">f</span><span class="punctor">(</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">process</span> <span class="keyword">wait</span> <span class="identifier">loadResource</span><span class="punctor">(</span><span class="identifier">something</span><span class="punctor">)</span></pre></div><div class="comm"><code>wait</code> is a special call wrapper related to the monadic primitive system, dealing with callbacks, see section "Coping with Callbacks".</div>

<h2>Coping with Callbacks</h2>

<div class="show"><pre class="mghl source moe"><span class="comment">-- A function using `wait`...</span>
<span class="keyword">def</span> <span class="identifier">f</span><span class="punctor">(</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">process</span> <span class="keyword">wait</span> <span class="identifier">loadResource</span><span class="punctor">(</span><span class="identifier">something</span><span class="punctor">)</span>

<span class="comment">-- ...will make f into</span>
<span class="keyword">def</span> <span class="identifier">f_1</span> <span class="operator">=</span> <span class="punctor">[</span><span class="identifier">build</span><span class="punctor">:</span> <span class="identifier">fBuild</span><span class="punctor">]</span>
<span class="keyword">where</span> <span class="identifier">fBuild</span><span class="punctor">(</span><span class="identifier">schemata</span><span class="punctor">)</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword flowctrl">return</span> <span class="identifier">schemata</span><span class="punctor">.</span><span class="identifier">yield</span> <span class="identifier">loadResource</span> <span class="identifier">something</span><span class="punctor">,</span> <span class="punctor">(</span><span class="identifier">resource</span><span class="punctor">)</span> <span class="operator">:></span>
        <span class="keyword flowctrl">return</span> <span class="identifier">schemata</span><span class="punctor">.</span><span class="keyword flowctrl">return</span> <span class="identifier">process</span> <span class="identifier">resource</span></pre></div><div class="comm"><p>The call wrapper <code>wait</code> is used for generate callback-requiring methods. A simplified form of <code>wait f(args)</code> is <code>f!(args)</code>.</p>
<p>A function containing <code>wait</code>, <code>!</code> or <code>&lt;-</code> (called <strong>Bind Arrow</strong>) will be transformed into a completely different thing called <strong>Monadic Primitive</strong>. A monadic primitive has the form <code>[build: function(schemata)(args)()...]</code>.</p>
<p>In the original form of monadic primitives, <code>schemata</code> is an object with several methods, including <code>yield</code>, <code>bind</code> and <code>return</code>. Some uses of monadic primitive, including generators and list comprehension, requires this. <code>args</code> is the argument list, and the 3rd group of brackets starts the actions.</p>
<p>Moe compiler will transform <code>f! args</code> into <code>schemata.yield f args, (_) =&gt; rest</code> where <code>rest</code> stands for the rest actions. The bind arrow, <code>x &lt;- val</code>, will be transformed into <code>schemata.bind val, (x) =&gt; rest</code>. So that <code>schemata</code> is a key object in monad construction. It represents the type of monads.</p>
</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">async</span> <span class="identifier">randPrintNums</span><span class="punctor">(</span><span class="identifier">n</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword">def</span> <span class="identifier">tasks</span> <span class="operator">=</span> <span class="punctor">[</span><span class="punctor">]</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">i</span> <span class="operator">in</span> <span class="number literal">0</span><span class="operator">..</span><span class="identifier">n</span><span class="punctor">)</span>
        <span class="identifier">tasks</span><span class="punctor">.</span><span class="identifier">push</span> <span class="identifier">async</span> <span class="operator">:></span>
            <span class="keyword">wait</span> <span class="identifier">sleep</span> <span class="punctor">(</span><span class="number literal">100</span> <span class="operator">*</span> <span class="identifier">Math</span><span class="punctor">.</span><span class="identifier">random</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">)</span>
            <span class="identifier">trace</span> <span class="identifier">index</span>
        <span class="keyword">where</span> <span class="identifier">index</span> <span class="operator">=</span> <span class="identifier">i</span>
    <span class="keyword">wait</span> <span class="identifier">join</span> <span class="identifier">tasks</span>

<span class="identifier">randPrintNums</span> <span class="number literal">100</span></pre></div><div class="comm">However, raw primitives is hard to use, so that monadic primitives is often wrapped by library functions. A useful function is <code>async</code> from <code>moe/libs/async</code>, dealing with most of the callback-requiring actions in JavaScript.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">enumeration</span> <span class="identifier">String</span><span class="operator">::</span><span class="identifier">getEnumerator</span><span class="punctor">(</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">i</span> <span class="operator">in</span> <span class="number literal">0</span><span class="operator">..</span><span class="keyword">this</span><span class="punctor">.</span><span class="identifier">length</span><span class="punctor">)</span>
        <span class="identifier">enumeration</span><span class="punctor">.</span><span class="identifier">yield</span><span class="operator">!</span> <span class="keyword">this</span><span class="punctor">.</span><span class="identifier">charAt</span><span class="punctor">(</span><span class="identifier">i</span><span class="punctor">)</span><span class="punctor">,</span> <span class="identifier">i</span>

<span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">in</span> <span class="string literal">"this is a string"</span><span class="punctor">)</span>
    <span class="identifier">trace</span> <span class="identifier">x</span></pre></div><div class="comm">Another useful function is <code>enumeration</code>, creating iterators.</div><div class="show"><pre class="mghl source moe"><span class="keyword">def</span> <span class="identifier">Enumerable</span> <span class="identifier">twiceRange</span><span class="punctor">(</span><span class="identifier">range</span><span class="punctor">)</span><span class="punctor">:</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="operator">*</span><span class="identifier">x</span> <span class="operator">in</span> <span class="identifier">range</span><span class="punctor">)</span>
        <span class="punctor">(</span><span class="punctor">)</span> <span class="operator">&lt;-</span> <span class="identifier">x</span>
    <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="operator">*</span><span class="identifier">x</span> <span class="operator">in</span> <span class="identifier">range</span><span class="punctor">)</span>
        <span class="punctor">(</span><span class="punctor">)</span> <span class="operator">&lt;-</span> <span class="identifier">x</span>

<span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">in</span> <span class="identifier">twiceRange</span><span class="punctor">(</span><span class="number literal">1</span><span class="operator">..</span><span class="number literal">10</span><span class="punctor">)</span><span class="punctor">)</span>
    <span class="identifier">trace</span> <span class="identifier">x</span></pre></div><div class="comm"><code>Enumerable</code> is a wrap of <code>enumeration</code>, creates enumerable object constructors.</div><div class="show"><pre class="mghl source moe"><span class="comment">-- Enumerator comprehension monad</span>
<span class="keyword">var</span> <span class="identifier">ecSchemata</span> <span class="operator">=</span> <span class="punctor">[</span><span class="identifier">yield</span><span class="punctor">:</span> <span class="identifier">fYield</span><span class="punctor">,</span> <span class="keyword flowctrl">return</span><span class="punctor">:</span> <span class="identifier">fReturn</span><span class="punctor">,</span> <span class="identifier">bind</span><span class="punctor">:</span> <span class="identifier">fBind</span><span class="punctor">]</span>
<span class="keyword">where</span> 
    <span class="identifier">fReturn</span> <span class="operator">=</span> <span class="identifier">Enumerable</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span><span class="punctor">:</span>
        <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">x</span> <span class="operator">!=</span> <span class="literal">undefined</span><span class="punctor">)</span>
            <span class="identifier">enumeration</span><span class="punctor">.</span><span class="identifier">yield</span><span class="operator">!</span> <span class="identifier">x</span>
    <span class="identifier">fYield</span><span class="punctor">(</span><span class="identifier">x</span><span class="punctor">)</span> <span class="operator">=</span> <span class="identifier">x</span>
    <span class="identifier">fBind</span> <span class="operator">=</span> <span class="identifier">Enumerable</span> <span class="keyword function">function</span><span class="punctor">(</span><span class="identifier">list</span><span class="punctor">,</span> <span class="identifier">callback</span><span class="punctor">)</span><span class="punctor">:</span>
        <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">in</span> <span class="identifier">list</span><span class="punctor">)</span> 
            <span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">y</span> <span class="operator">in</span> <span class="identifier">callback</span> <span class="identifier">x</span><span class="punctor">)</span>
                <span class="identifier">enumeration</span><span class="punctor">.</span><span class="identifier">yield</span><span class="operator">!</span> <span class="identifier">y</span>

<span class="keyword">var</span> <span class="identifier">table</span><span class="punctor">(</span><span class="identifier">G</span><span class="punctor">)</span> <span class="operator">=</span>
    <span class="keyword">var</span> <span class="identifier">f</span> <span class="operator">=</span> <span class="identifier">G</span><span class="punctor">.</span><span class="identifier">build</span> <span class="identifier">ecSchemata</span>
    <span class="identifier">f</span><span class="punctor">.</span><span class="identifier">apply</span><span class="punctor">(</span><span class="keyword">this</span><span class="punctor">,</span> <span class="keyword">arguments</span><span class="punctor">)</span><span class="punctor">(</span><span class="punctor">)</span>

<span class="comment">// simple usage</span>
<span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">item</span> <span class="operator">in</span> <span class="identifier">table</span><span class="punctor">{</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">&lt;-</span> <span class="punctor">(</span><span class="number literal">1</span><span class="operator">..</span><span class="number literal">100</span><span class="punctor">)</span><span class="punctor">;</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="number literal">2</span> <span class="operator">+</span> <span class="number literal">1</span><span class="punctor">}</span><span class="punctor">)</span> <span class="identifier">trace</span> <span class="identifier">item</span>

<span class="comment">// complicated usage</span>
<span class="keyword">var</span> <span class="identifier">t</span> <span class="operator">=</span> <span class="identifier">table</span> <span class="punctor">{</span><span class="keyword">var</span> <span class="identifier">x</span> <span class="operator">&lt;-</span> <span class="punctor">(</span><span class="number literal">1</span><span class="operator">...</span><span class="number literal">9</span><span class="punctor">)</span><span class="punctor">;</span> <span class="keyword">var</span> <span class="identifier">y</span> <span class="operator">&lt;-</span> <span class="punctor">(</span><span class="number literal">1</span><span class="operator">...</span><span class="number literal">9</span><span class="punctor">)</span><span class="punctor">;</span> <span class="keyword flowctrl">if</span><span class="punctor">(</span><span class="identifier">x</span> <span class="operator">&lt;=</span> <span class="identifier">y</span><span class="punctor">)</span> <span class="identifier">x</span> <span class="operator">+</span> <span class="string literal">' * '</span> <span class="operator">+</span> <span class="identifier">y</span> <span class="operator">+</span> <span class="string literal">' = '</span> <span class="operator">+</span> <span class="identifier">x</span> <span class="operator">*</span> <span class="identifier">y</span> <span class="punctor">}</span>
<span class="comment">// t = table [build: fBuild]</span>
<span class="comment">// where fBuild(schemata)()() =</span>
<span class="comment">//     schemata.bind (1...9), (x) =></span>
<span class="comment">//         schemata.bind (1...9), (y) =></span>
<span class="comment">//             if(x &lt;= y) schemata.return (x + ' * ' + y + ' = ' + x * y)</span>
<span class="comment">//             else schemata.return()</span>
<span class="keyword flowctrl">for</span><span class="punctor">(</span><span class="keyword">var</span> <span class="identifier">item</span> <span class="operator">in</span> <span class="identifier">t</span><span class="punctor">)</span> <span class="identifier">trace</span> <span class="identifier">item</span></pre></div><div class="comm">Even more interesting things could be implemented by monadic primitives, due to it is actually an abstraction of flow control. In some situation, callbacks are not called only once, produces "strange" behaviors, for example, enumerator comprehension:</div>
<h2>Links</h2>

<ul><li>Moescript: <a href="http://github.com/be5invis/moescript">http://github.com/be5invis/moescript</a>
</li>
<li>Library: <a href="lib/index.html">lib/index</a>
</li>
</ul>
</div></body></html>